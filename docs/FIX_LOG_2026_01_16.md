# ğŸ”§ Fix Log: Payment Flow & Login Issues (16 Januari 2026)

> **Tanggal:** 16 Januari 2026  
> **Jam:** 16:00 - 18:25 WIB  
> **Status:** âœ… RESOLVED

---

## ğŸ“‹ Masalah yang Dilaporkan

1. **Login Error 404** - Login di Landing Page gagal dengan error 404
2. **Harga tidak terpotong voucher** - Halaman payment confirmation menampilkan harga normal, bukan harga setelah diskon
3. **Redirect ke localhost** - Link "Daftar" mengarah ke localhost:3002
4. **Dashboard API 404** - Setelah login, dashboard tampil error karena API 404

---

## ğŸ” Root Cause Analysis

### Masalah Utama: Cross-Domain Architecture Tidak Tertangani dengan Benar

Proyek ini memiliki 2 domain:
- **Landing Page** (`adspilot.id`) - `landing-page-v2` project
- **User Portal** (`app.adspilot.id`) - `app` project

Masalah terjadi karena:

1. **File `.env.local` di server tidak memiliki `NEXT_PUBLIC_API_URL`**
   - Landing Page tidak tahu URL API User Portal
   - Semua API call menjadi relative path (ke domain sendiri)

2. **AuthContext menggunakan relative path**
   - `/api/auth/login` â†’ request ke `adspilot.id/api/auth/login` (SALAH)
   - Seharusnya: `https://app.adspilot.id/api/auth/login`

3. **Login redirect menggunakan `router.push()` (relative)**
   - Setelah login, redirect ke `/general` â†’ tetap di `adspilot.id/general`
   - Landing Page tidak punya halaman `/general` â†’ 404

4. **CORS credentials conflict**
   - Fetch dengan `credentials: 'include'` tidak kompatibel dengan `Access-Control-Allow-Origin: *`

---

## ğŸ› ï¸ Perbaikan yang Dilakukan

### 1. Fix Environment Variables di Server

**File:** `landing-page-v2/.env` di server

**Perubahan:**
```env
# Ditambahkan:
NEXT_PUBLIC_API_URL=https://app.adspilot.id
NEXT_PUBLIC_APP_URL=https://adspilot.id
```

**Alasan:** Environment variable must exist at build time for Next.js `NEXT_PUBLIC_*` variables.

---

### 2. Fix AuthContext API URL

**File:** `landing-page-v2/contexts/AuthContext.tsx`

**Sebelum:**
```typescript
const response = await fetch('/api/auth/login', {
  method: 'POST',
  ...
})
```

**Sesudah:**
```typescript
const response = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/auth/login`, {
  method: 'POST',
  ...
})
```

**Alasan:** API Login ada di User Portal, bukan di Landing Page.

---

### 3. Remove CORS Credentials

**File:** `landing-page-v2/contexts/AuthContext.tsx`

**Dihapus:**
```typescript
credentials: 'include',
```

**Alasan:** `credentials: 'include'` tidak kompatibel dengan `Access-Control-Allow-Origin: *`. Karena menggunakan token di header Authorization, credentials tidak diperlukan.

---

### 4. Fix Login Redirect

**File:** `landing-page-v2/app/auth/login/page.tsx`

**Sebelum:**
```typescript
if (user.status_user === 'pending_payment') {
  router.push('/dashboard/payment-status')
} else {
  router.push('/general')
}
```

**Sesudah:**
```typescript
const userPortalUrl = process.env.NEXT_PUBLIC_API_URL || 'https://app.adspilot.id'
if (user.status_user === 'pending_payment') {
  window.location.href = `${userPortalUrl}/dashboard/payment-status`
} else {
  window.location.href = `${userPortalUrl}/general`
}
```

**Alasan:** Setelah login di Landing Page, user harus redirect ke User Portal domain, bukan tetap di Landing Page.

---

### 5. Fix Payment Confirmation Fallback

**File:** `landing-page-v2/app/auth/payment-confirmation/page.tsx`

**Perubahan:**
Menambahkan kondisi untuk menampilkan error message jika `transactionId` ada tapi fetch gagal, bukan fallback ke harga plan normal.

**Alasan:** Mencegah tampilan harga yang salah jika data transaksi gagal di-fetch.

---

### 6. Fix Voucher Validation Logic (Backend)

**File:** `app/app/api/auth/register/route.ts`

**Perubahan:**
```typescript
// Sebelum: Hanya mengambil price
'SELECT price FROM subscription_plans ...'

// Sesudah: Mengambil price DAN original_price
'SELECT price, original_price FROM subscription_plans ...'

// Validasi minimum purchase menggunakan max(price, original_price)
const baseAmountForValidation = Math.max(baseAmount, originalPrice)
```

**Alasan:** Sinkronisasi logic validasi voucher antara frontend dan backend.

---

## ğŸ“ Commits

1. `f3768e0` - Fix: Sync voucher minimum purchase validation logic with frontend (use original_price)
2. `9de9ee9` - Fix: Payment confirmation page now only shows data from database, not fallback plan price
3. `7202abb` - Fix: Landing Page auth API calls now use User Portal API URL
4. `65fd3f3` - Fix: Remove credentials include to avoid CORS error
5. `e795922` - Fix: Redirect to User Portal after login instead of staying on Landing Page

---

## âœ… Testing Checklist

- [x] Login di `adspilot.id/auth/login` berhasil
- [x] Redirect ke `app.adspilot.id/general` setelah login
- [x] Dashboard tampil dengan benar
- [x] Tidak ada error CORS
- [x] Tidak ada error 404
- [ ] Register dengan voucher menampilkan diskon (perlu test dengan user baru)
- [ ] Payment confirmation menampilkan total yang benar

---

## ğŸ“Œ Known Issues / TODO

1. **Duplikasi halaman antara Landing Page dan User Portal** 
   - Lihat: `docs/LANDING_PAGE_CLEANUP.md`
   - Status: Low priority, akan dikerjakan setelah presentasi

2. **Test voucher flow end-to-end**
   - Perlu register user baru dengan voucher untuk verify harga terpotong

---

## ğŸ—ï¸ Architecture Notes

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   adspilot.id       â”‚
                    â”‚  (Landing Page)     â”‚
                    â”‚                     â”‚
                    â”‚  - Homepage         â”‚
                    â”‚  - /auth/login      â”‚
                    â”‚  - /auth/register   â”‚
                    â”‚  - /auth/checkout   â”‚
                    â”‚  - /auth/payment-*  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ After login,
                              â”‚ redirect to
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ app.adspilot.id     â”‚
                    â”‚  (User Portal)      â”‚
                    â”‚                     â”‚
                    â”‚  - /general         â”‚
                    â”‚  - /automations     â”‚
                    â”‚  - /accounts        â”‚
                    â”‚  - /dashboard/*     â”‚
                    â”‚  - /api/*           â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

*Dokumentasi ini dibuat untuk referensi troubleshooting di masa depan.*
